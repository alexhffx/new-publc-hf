---
export const prerender = false;

import PageLayout from '../../layouts/PageLayout.astro';
import CTASection from '../../components/CTASection.astro';
import { getWebinar, urlFor } from '../../lib/sanity';

const { slug } = Astro.params;
const webinar = await getWebinar(slug || '');

if (!webinar) {
  return Astro.redirect('/404');
}

const isUpcoming = new Date(webinar.eventDate) > new Date();
const formattedDate = new Date(webinar.eventDate).toLocaleDateString('en-GB', {
  weekday: 'long',
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
const formattedTime = new Date(webinar.eventDate).toLocaleTimeString('en-GB', {
  hour: '2-digit',
  minute: '2-digit',
});
---

<PageLayout
  title={`${webinar.title} — Webinar`}
  description={webinar.description || `${isUpcoming ? 'Register for' : 'Watch'} the HedgeFlows webinar: ${webinar.title}`}
>
  <section class="section-padding">
    <div class="container-content max-w-3xl mx-auto">
      {/* Breadcrumb */}
      <nav class="mb-8 text-[0.875rem] text-text-muted">
        <a href="/webinars" class="hover:text-brand-green transition-colors">Webinars</a>
        <span class="mx-2">/</span>
        <span class="text-text-heading font-medium">{webinar.title}</span>
      </nav>

      {isUpcoming ? (
        <span class="inline-block px-3 py-1 bg-brand-green text-white text-[0.8125rem] font-bold rounded-full mb-4">
          Upcoming
        </span>
      ) : (
        <span class="inline-block px-3 py-1 bg-gray-200 text-text-muted text-[0.8125rem] font-bold rounded-full mb-4">
          Past event
        </span>
      )}

      <h1 class="text-[2rem] md:text-[2.5rem] font-bold text-text-heading leading-tight mb-4">
        {webinar.title}
      </h1>

      <div class="flex flex-wrap gap-4 text-[0.9375rem] text-text-body mb-8">
        <span class="flex items-center gap-2">
          <svg class="w-5 h-5 text-brand-green" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
          </svg>
          {formattedDate}
        </span>
        <span class="flex items-center gap-2">
          <svg class="w-5 h-5 text-brand-green" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          {formattedTime} GMT
        </span>
      </div>

      {webinar.thumbnail && (
        <img
          src={urlFor(webinar.thumbnail).width(800).auto('format').url()}
          alt={webinar.title}
          class="w-full rounded-xl shadow-md mb-10"
          loading="eager"
        />
      )}

      {webinar.description && (
        <div class="text-[1.0625rem] text-text-body leading-relaxed mb-10 whitespace-pre-line">
          {webinar.description}
        </div>
      )}

      {/* Speakers */}
      {webinar.speakers && webinar.speakers.length > 0 && (
        <div class="mb-10">
          <h2 class="text-[1.25rem] font-semibold text-text-heading mb-5">Speakers</h2>
          <div class="flex flex-wrap gap-6">
            {webinar.speakers.map((speaker: any) => (
              <div class="flex items-center gap-3">
                {speaker.photo ? (
                  <img
                    src={urlFor(speaker.photo).width(80).height(80).auto('format').url()}
                    alt={speaker.name}
                    class="w-12 h-12 rounded-full object-cover"
                  />
                ) : (
                  <div class="w-12 h-12 rounded-full bg-brand-green-pale flex items-center justify-center">
                    <span class="text-brand-green font-bold text-[0.75rem]">
                      {speaker.name?.split(' ').map((n: string) => n[0]).join('').slice(0, 2)}
                    </span>
                  </div>
                )}
                <div>
                  <p class="font-semibold text-text-heading text-[0.9375rem]">{speaker.name}</p>
                  {speaker.role && <p class="text-[0.8125rem] text-text-muted">{speaker.role}</p>}
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* CTA based on status */}
      {isUpcoming && webinar.registrationUrl && (
        <div class="p-8 bg-brand-green-pale rounded-xl text-center">
          <h3 class="text-[1.25rem] font-semibold text-text-heading mb-3">Register for this event</h3>
          <p class="text-text-body mb-5">Secure your spot — spaces are limited.</p>
          <a
            href={webinar.registrationUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="btn-primary text-[1.0625rem] px-8 py-4"
          >
            Register now
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" />
            </svg>
          </a>
        </div>
      )}

      {!isUpcoming && webinar.recordingUrl && (
        <div class="p-8 bg-brand-green-pale rounded-xl text-center">
          <h3 class="text-[1.25rem] font-semibold text-text-heading mb-3">Watch the recording</h3>
          <a
            href={webinar.recordingUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="btn-primary text-[1.0625rem] px-8 py-4"
          >
            Watch now
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
              <path d="M8 5v14l11-7z"/>
            </svg>
          </a>
        </div>
      )}

      <div class="mt-12">
        <a href="/webinars" class="inline-flex items-center gap-2 text-brand-green font-semibold hover:gap-3 transition-all">
          <svg class="w-4 h-4 rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" />
          </svg>
          Back to webinars
        </a>
      </div>
    </div>
  </section>
</PageLayout>
