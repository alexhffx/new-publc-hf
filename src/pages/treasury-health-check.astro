---
import PageLayout from '../layouts/PageLayout.astro';
import { getPage } from '../lib/sanity';

const page = await getPage('treasury-health-check');
---

<PageLayout
  title={page?.seoTitle || page?.title || 'Book a Treasury Health Check | HedgeFlows'}
  description={page?.seoDescription || 'Book a free treasury health check and uncover hidden costs in your FX, banking, and cash management.'}
>
  {/* ── Heading + Calendly Widget ────────────────────────────── */}
  <section class="pt-16 pb-20 md:pt-20 md:pb-28" id="book">
    <div class="container-content max-w-6xl mx-auto">
      <div class="text-center mb-10">
        <h1 class="text-[2rem] md:text-[2.75rem] font-bold text-text-heading leading-tight mb-4">
          Book your free treasury review
        </h1>
        <p class="text-[1.125rem] md:text-[1.25rem] text-text-body leading-relaxed max-w-2xl mx-auto">
          See what your international finances are really costing you. Pick a time and we'll show you exactly where you can save.
        </p>
      </div>
      <div class="bg-white rounded-2xl border border-gray-100 shadow-[0_1px_3px_rgba(0,0,0,0.04),0_6px_24px_rgba(0,0,0,0.04)] overflow-hidden">
        <!-- Calendly widget (loads when marketing cookies accepted) -->
        <div
          id="calendly-widget"
          class="calendly-inline-widget"
          data-url="https://calendly.com/hedgeflows-aa/30min?hide_gdpr_banner=1"
          style="min-width:320px;height:700px;"
        ></div>

        <!-- Placeholder when cookies not accepted -->
        <div id="calendly-placeholder" class="hidden flex flex-col items-center justify-center text-center py-20 px-6" style="min-height:500px;">
          <div class="w-14 h-14 rounded-2xl bg-brand-green-pale flex items-center justify-center mb-5">
            <svg class="w-7 h-7 text-brand-green" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
            </svg>
          </div>
          <p class="text-[1.0625rem] font-semibold text-text-heading mb-2">Booking widget requires cookies</p>
          <p class="text-[0.9375rem] text-text-body leading-relaxed max-w-md mb-6">
            This booking calendar is provided by Calendly. Please accept marketing cookies to load it, or email us directly at
            <a href="mailto:hello@hedgeflows.com" class="text-brand-green font-medium hover:underline">hello@hedgeflows.com</a>.
          </p>
          <button
            onclick="window.dispatchEvent(new Event('hf:show-consent'))"
            class="px-6 py-2.5 text-[0.875rem] font-semibold border-2 border-brand-green text-brand-green bg-white rounded-full hover:bg-brand-green hover:text-white transition-all duration-200 cursor-pointer"
          >
            Manage Cookie Preferences
          </button>
        </div>
      </div>
    </div>
  </section>
</PageLayout>

<script is:inline>
(function() {
  var STORAGE_KEY = 'hf-cookie-consent';
  var widgetEl = document.getElementById('calendly-widget');
  var placeholderEl = document.getElementById('calendly-placeholder');

  function loadCalendly() {
    if (document.querySelector('script[src*="calendly"]')) return;
    var s = document.createElement('script');
    s.src = 'https://assets.calendly.com/assets/external/widget.js';
    s.async = true;
    document.body.appendChild(s);
    if (widgetEl) widgetEl.classList.remove('hidden');
    if (placeholderEl) placeholderEl.classList.add('hidden');
  }

  function showPlaceholder() {
    if (widgetEl) widgetEl.classList.add('hidden');
    if (placeholderEl) placeholderEl.classList.remove('hidden');
  }

  // Check existing consent
  var consent = null;
  try { consent = JSON.parse(localStorage.getItem(STORAGE_KEY)); } catch(e) {}

  if (consent && consent.marketing) {
    loadCalendly();
  } else if (consent && !consent.marketing) {
    showPlaceholder();
  }
  // If no consent yet, widget div stays visible but empty (banner is showing)

  // Listen for consent changes
  window.addEventListener('hf:consent', function(e) {
    if (e.detail.marketing) {
      loadCalendly();
    } else {
      showPlaceholder();
    }
  });
})();
</script>
